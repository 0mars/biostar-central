
INPUT_DATA = {{data.value}}
INPUT_SAMPLE_INFO := {{sampleinfo.value}}


#
# Internal parameters after this.
#

DATA_DIR = data
RESULT_DIR  = results

PTRIM_DIR = $(DATA_DIR)/trim/trimp
QTRIM_DIR = $(DATA_DIR)/trim/trimq
UPDATED_SAMPLE_INFO = updated_sampleinfo.txt

UNPACKED_FASTQ = $(DATA_DIR)/*.fastq.gz
FASTQC_REPORT = $(DATA_DIR)/*_fastqc.html
TRIMMED_PRIMER = $(PTRIM_DIR)/*.gz
TRIMMED_QUALITY =$(QTRIM_DIR)/*.gz

all: $(FASTQC_REPORT)
	@echo "executes all commands"


$(FASTQC_REPORT): $(UNPACKED_FASTQ)
 	fastqc --nogroup $@ -o $(DATA_DIR)
	#ls $(DATA_DIR)/*.gz | parallel --verbose --progress -j 8 fastqc --nogroup {} -o $(DATA_DIR)

ERR_LOG = stderr.txt

$(UPDATED_SAMPLE_INFO): $(INPUT_SAMPLE_INFO)
	#	
	# Make new sample sheet named $(UPDATED_SAMPLE_INFO)
	#
	python -m pipeline.data.samplesheet $(INPUT_SAMPLE_INFO) $(DATA_DIR) > $(UPDATED_SAMPLE_INFO)


multiqc: fastqc $(RESDIR)
	#
	# run multiqc to create an aggregate report
	#
	mkdir -p $(RESDIR)
	multiqc -f -n input_multiqc -o $(DATADIR) $(DATADIR)
	cp $(DATADIR)/input_multiqc.html $(RESDIR)
	#
	# clean
	#
	#rm -f $(DATADIR)/*fastqc.zip

$(TRIMMED_PRIMER): $(UPDATED_SAMPLE_INFO) $(INPUT_DATA)
	#
	mkdir -p $(PTRIM_DIR)/logs
	#
	#
	# trim left primer
	mkdir -p $(RESULT_DIR)
	cat $(UPDATED_SAMPLE_INFO) |parallel --verbose --progress  --header : --colsep '\t' bbduk.sh \
	in1=$(DATA_DIR)/{file1} in2=$(DATA_DIR)/{file2} \
	out1=$(PTRIM_DIR)/{sample_name}_fwd1_trim.fq.gz \
	out2=$(PTRIM_DIR)/{sample_name}_fwd2_trim.fq.gz \
	literal={barcode}{fwd_primer} ktrim=l k=23 hdist=1 tpe tbo overwrite=true \
	overwrite=t skipr2=t stats=$(PTRIM_DIR)/logs/{sample_name}_fwd_stats.txt

	#
	# trim right primer
	#
	cat $(UPDATED_SAMPLE_INFO) | parallel --verbose --progress --header : --colsep '\t' bbduk.sh  \
	in1=$(PTRIM_DIR)/{sample_name}_fwd1_trim.fq.gz \
	in2=$(PTRIM_DIR)/{sample_name}_fwd2_trim.fq.gz \
	out1=$(PTRIM_DIR)/{sample_name}_R1_trimp.fq.gz \
	out2=$(PTRIM_DIR)/{sample_name}_R2_trimp.fq.gz  \
	literal={barcode}{rev_primer} ktrim=l k=28 hdist=1 tpe tbo overwrite=true \
	skipr1=t stats=$(PTRIM_DIR)/logs/{sample_name}_rev_stats.txt
	#
	# clean
	#
	cat $(PTRIM_DIR)/logs/*stats.txt > $(RESULT_DIR)/trimp_stats.txt
	#rm -f $(PTRIM_DIR)/*trimfwd*


$(TRIMMED_QUALITY): $(TRIMMED_PRIMER)
	mkdir -p $(QTRIM_DIR)/logs
	cat  $(UPDATED_SAMPLE_INFO) |parallel --verbose --progress  --header : --colsep '\t' bbduk.sh \
	in1=$(PTRIM_DIR)/{sample_name}_R1_trimp.fq.gz in2=$(PTRIM_DIR)/{sample_name}_R2_trimp.fq.gz \
	qtrim=rl trimq={{trim_quality.value}}  minlength=35 overwrite=true \
	out1=$(QTRIM_DIR)/{sample_name}_R1_trim.fq.gz \
	out2=$(QTRIM_DIR)/{sample_name}_R2_trim.fq.gz stats=$(QTRIM_DIR)/logs/{sample_name}_stats.txt
	cat $(QTRIM_DIR)/logs/*stats.txt > $(RESULT_DIR)/trimq_stats.txt
	#
	# quality report
	#
	ls $(QTRIM_DIR)/*gz | parallel --verbose --progress -j 8 fastqc --nogroup {} -o $(QTRIM_DIR)
	multiqc -n trim_multiqc --force -o $(QTRIM_DIR) $(QTRIM_DIR)
	cp $(QTRIM_DIR)/trim_multiqc.html $(RESULT_DIR)

