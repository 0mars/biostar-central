{% extends "base_content.html" %}
{% load static %}
{% load engine_tags %}

{% block js %}

    <link rel="stylesheet" href="{% static 'codemirror/codemirror.css' %}{% randparam %}">

    <script src="{% static 'codemirror/codemirror.js' %}"></script>
    <script src="{% static 'codemirror/mode/simple.js' %}"></script>
    <script src="{% static 'codemirror/mode/engine.js' %}"></script>
    <script src="{% static 'codemirror/mode/shell.js' %}"></script>

    {#  Javascript code that handles the recipe interfaces. #}
    <script src="{% static 'setup.js' %}{% randparam %}"></script>
    <script src="{% static 'recipes.js' %}{% randparam %}"></script>

{% endblock %}

{% block headtitle %}
    Recipe View
{% endblock %}

{% block content %}

    {% if recipe.is_cloned %}

        <div class="ui vertical segment">
            <span class="muted">
                <i class="linkify icon"></i>
                This recipe is a clone.
                It remains synchronized with the <a href="{{ recipe.root.url }}">parent recipe</a>
                written by <a href="{{ recipe.root.owner.profile.get_absolute_url }}">
                {{ recipe.root.owner.profile.name|truncatechars:30 }}</a>.
            </span>
        </div>

    {% endif %}


    <div class="ui grid">

        {# Side bar #}
        <div class="three wide column">
            <div class="ui vertical large text menu">

                <a class="item click" href="#" data-value="#info">
                    <i class="info circle icon"></i> Recipe description
                </a>


                <a class="item click" href="#" data-value="#code">
                    <i class="code icon"></i> Recipe code
                </a>


                <a class="item click" href="#" data-value="#interface">
                    <i class="tv icon"></i> Recipe interface
                </a>

                <a class="item" href="{% url 'recipe_download' recipe.uid %}">
                    <i class="download icon"></i> Download recipe
                </a>


                <a class="item" href="{% url 'recipe_run' recipe.uid %}">
                    <i class="setting icon"></i> Run recipe
                </a>

                <a class="item" href="{% url 'job_list' project.uid %}?filter={{ recipe.uid }}">
                    <i class="settings icon"></i> Recipe results ({{ recipe.job_count }})
                </a>

            </div>
        </div>

        <div class="thirteen wide column">

            {#  Description #}
            <div class="ui basic segment collapse" id="info">

                {#  Recipe info. #}
                <div class="ui divided link items">
                    {% recipe_details recipe %}
                </div>

                <div class="ui vertical segment">
                    {{ recipe.html | safe }}
                </div>

                <div class="ui center aligned vertical segment">
                    <a class="ui gray button click" href="#" data-value="#edit">
                        <i class="edit icon"></i> Edit description
                    </a>
                </div>
            </div>

            {#  Script #}
            <div class="ui basic segment collapse" id="code">
                <form method="post" class="ui form" action="#" enctype='multipart/form-data'>

                    <div class="ui vertical segment">
                        <div class="ui title header">Recipe Code</div>
                    </div>
                    <div class="field" id="template_field">
                    <textarea class="code" rows="40" cols="55"
                              name="template">{{ form.template.value }}</textarea>
                    </div>

                    {# The recipe primary id #}
                    <input type="hidden" name="id" value="{{ recipe.id }}">

                    <div class="item">
                        <button class="ui green button" type="submit">
                            <i class="save icon"></i> Save Code
                        </button>

                        <a class="ui right floated gray button click" data-value="#info">
                            <i class="arrow left icon"></i> Back
                        </a>
                    </div>
                </form>

            </div>

            {#  Interface #}
            <div class="ui basic segment collapse" id="interface">
                <form method="post" class="ui form" action="#" enctype='multipart/form-data'>

                    <div class="ui vertical segment">
                        <div class="ui title header">Recipe Interface</div>
                    </div>
                    <div class="field" id="json_field">
                        <textarea class="code" rows="40" cols="55"
                                  name="json_text">{{ form.json_text.value }}</textarea>
                    </div>

                    {# The recipe primary id #}
                    <input type="hidden" name="id" value="{{ recipe.id }}">

                    <div class="item">
                        <button class="ui green button" type="submit">
                            <i class="save icon"></i> Save Interface
                        </button>

                        <a class="ui right floated gray button click" data-value="#info">
                            <i class="arrow left icon"></i> Back
                        </a>
                    </div>

                </form>
            </div>

            {# Edit recipe meta data. #}
            <div class="ui basic segment collapse formstyle" id="edit">

                <form method="post" class="ui form" action="#" enctype='multipart/form-data'>

                    <div class="ui title header">Edit Recipe</div>

                    <div class="two fields">
                        <div class="field">
                            <label>Name</label>
                            {{ form.name }}
                            <div class="muted">Recipe display name</div>
                        </div>
                        <div class="field">
                            <label>Identifier</label>
                            {{ form.uid }}
                            <div class="muted">Unique identifier for the recipe.</div>
                        </div>
                    </div>
                    {% if request.user.is_superuser %}
                        <div class="field">
                            <div class="ui checkbox">
                                {{ form.authorized }} <label>Authorized Recipe</label>
                            </div>
                            <p class="muted"> This recipe is safe to run by trusted users.</p>
                        </div>
                    {% endif %}

                    <div class="field">
                        {{ form.text }}
                        <div class="muted">A detailed explanation of what the recipe does (markdown OK).</div>
                    </div>

                    <div class="two fields">
                        <div class="field">
                            <span><b>Image</b> : </span>
                            {{ form.image.errors }}
                            {{ form.image }}
                            <div class="muted">Optional image for the recipe ( 500px Maximum ).</div>
                        </div>
                        <div class="field">
                            <span><b>Rank</b>: </span>
                            {{ form.rank }}
                            <div class="muted">Used to order recipes (optional).</div>
                        </div>
                    </div>

                    {# The recipe primary id #}
                    <input type="hidden" name="id" value="{{ recipe.id }}">

                    <div class="item">
                        <button class="ui green button" type="submit">
                            <i class="save icon"></i> Save
                        </button>

                        <a class="ui right floated gray button click" data-value="#info">
                            <i class="arrow left icon"></i> Back
                        </a>
                    </div>
                </form>
            </div>


        </div>

    </div>


{% endblock %}